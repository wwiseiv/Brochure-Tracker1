# Phase 3: AI-Custom Mode — RAG Pipeline + Website Scrape

## PREREQUISITE
Phase 2 must be complete. Template-Fill mode must be generating correct PDFs with contact info overlay, equipment, and conditional savings logic all working.

---

## SCOPE — WHAT THIS PHASE DELIVERS
1. AI-Custom mode activated (the mode toggle from Step 2 now does something different)
2. Optional website scraping for merchant business context
3. RAG-style context assembly from uploaded docs + template metadata
4. AI-generated customized copy that fills the selected template sections
5. Output remains a one-page PDF following the template style

## WHAT THIS PHASE DOES NOT DO
- No help menu / tooltip / AI assistant updates (Phase 4)

---

## HOW AI-CUSTOM MODE DIFFERS FROM TEMPLATE-FILL

| Aspect | Template-Fill | AI-Custom |
|--------|--------------|-----------|
| Merchant name | Direct insertion | Direct insertion |
| Savings numbers | Extracted verbatim from docs | Extracted verbatim (never invented) |
| Headline/subhead | Template default text | AI-customized to merchant's business type |
| Body copy | Template default text | AI-tailored based on business context |
| Equipment section | Direct insertion | Direct insertion with contextual framing |
| Contact info | Direct overlay | Direct overlay |
| Website URL field | Ignored | Scraped for business context |

**Key principle:** AI-Custom mode customizes the *copy/messaging* — it does NOT change the layout, and it does NOT invent financial numbers.

---

## STEP-BY-STEP INSTRUCTIONS

### 3.1 Website Scraping (Optional)

When the agent provides a merchant website URL in Step 2 and selects AI-Custom mode:

1. **Fetch** the single URL (and only that URL — no crawling)
2. **Extract** text content:
   - Strip HTML tags, scripts, styles
   - Keep: page title, meta description, headings, body text
   - Limit extracted text to ~2000 tokens max
3. **Sanitize:** Remove any script content, SQL, or potentially malicious strings
4. **Timeout:** 10 seconds max. If it fails, proceed without website context.
5. **Store** extracted text as structured context:

```javascript
{
  url: "https://example-merchant.com",
  pageTitle: "Example Merchant - Best Auto Repair in Indianapolis",
  metaDescription: "Full service auto repair...",
  bodyText: "We've been serving the Indianapolis area for 25 years...",
  businessType: "auto repair",  // inferred from content
  keywords: ["auto repair", "Indianapolis", "brakes", "oil change"]
}
```

**Implementation notes:**
- Use existing HTTP/fetch utilities in the project
- If the project has a proxy or scraping service, use it
- If not, a simple server-side fetch with cheerio or similar for HTML parsing
- User-agent: set a reasonable one, not a bot signature
- Respect robots.txt if practical (but don't over-engineer this)

**GRACEFUL DEGRADATION:** If scrape fails for any reason (timeout, blocked, invalid URL, SSL error), log the error and continue with AI-Custom mode using only uploaded docs and template context. Show a small info toast: "Couldn't access merchant website — generating based on uploaded documents."

### 3.2 Context Assembly (RAG-Lite)

Assemble a context package for the AI generation call:

```javascript
const contextPackage = {
  // Template context
  template: {
    id: selectedTemplate.templateId,
    name: selectedTemplate.displayName,
    category: selectedTemplate.category,
    sections: ["headline", "subheadline", "savingsBreakdown", "equipmentRecommendations", "features", "contactBlock"],
    tone: "professional, benefit-focused, action-oriented",
    constraint: "Must fit on a single page. Keep copy concise."
  },

  // Merchant context
  merchant: {
    name: "Muhlenkamp Sales and Service",
    websiteContext: websiteData || null,  // from 3.1, or null if no URL / scrape failed
  },

  // Financial data (extracted in Phase 2)
  financials: {
    dualPricingSavings: extractedData.dualPricing || null,
    surchargeSavings: extractedData.surcharge || null,
    traditionalSavings: extractedData.traditional || null,
    interchangePlusSavings: extractedData.interchangePlus || null,
    monthlyVolume: extractedData.monthlyVolume || null,
  },

  // Equipment
  equipment: {
    name: selectedEquipment.name,
    price: selectedEquipment.price || null,
    description: selectedEquipment.description || null,
  },

  // Agent
  agent: {
    firstName: agentInfo.firstName,
    lastName: agentInfo.lastName,
    title: agentInfo.title,
    phone: agentInfo.phone,
    email: agentInfo.email,
  }
};
```

### 3.3 AI Generation Call

Use the project's existing AI integration (OpenAI, Anthropic, or whatever is already configured) to generate customized copy.

**System prompt for the AI call:**

```
You are a copywriter for PCBancard, a payment processing company. You are generating content for a one-page sales proposal/flyer.

RULES:
1. Keep all copy concise — this must fit on a single printed page.
2. NEVER invent financial numbers. Only use the exact savings amounts provided in the financial data. If no numbers are provided, use phrases like "significant savings" or "let us show you the numbers."
3. Customize the headline and body copy to resonate with the merchant's specific business type and industry.
4. Maintain a professional, benefit-focused, action-oriented tone.
5. Include the agent's name naturally in the copy where appropriate.
6. Output ONLY the text content for each section — no HTML, no formatting tags, no markdown.

OUTPUT FORMAT (respond with exactly this JSON structure):
{
  "headline": "Exclusive Offer for [Merchant Name]",
  "subheadline": "Optional subheadline tailored to their business",
  "savingsItems": [
    { "label": "Dual Pricing Program", "amount": "$655.44", "note": "in annual savings (our top recommendation)" },
    { "label": "Surcharge Program", "amount": "$1,238.67", "note": "in annual savings" }
  ],
  "equipmentItems": [
    { "name": "Dejavoo P1 Terminal", "detail": "Pay $295 upfront or opt for our free terminal program with a warranty." }
  ],
  "features": [
    "Next-day or instant funding options",
    "Full PCI compliance handled for you",
    "Free marketing audit",
    "Quick access to capital advances when needed"
  ],
  "customBodyCopy": "Optional — a 2-3 sentence paragraph tailored to the merchant's industry. Only include if website context is available."
}
```

**User message for the AI call:**

```
Generate customized one-page proposal content for:

TEMPLATE: {template.name} ({template.category})
MERCHANT: {merchant.name}
MERCHANT BUSINESS CONTEXT: {merchant.websiteContext.bodyText || "No website context available"}
MERCHANT BUSINESS TYPE: {merchant.websiteContext.businessType || "Unknown — use generic business language"}

FINANCIAL DATA (use these EXACT numbers, do not modify or round):
{JSON.stringify(financials, null, 2)}

EQUIPMENT: {equipment.name} — {equipment.price || "pricing available upon request"}

AGENT: {agent.firstName} {agent.lastName}
```

**IMPORTANT SAFEGUARDS:**
- Parse the AI response as JSON. If parsing fails, fall back to Template-Fill mode and show a toast: "AI customization unavailable — using standard template."
- Validate that savings amounts in the AI response match the extracted amounts exactly. If the AI changed a number, replace it with the original extracted number.
- If the AI adds savings amounts that weren't in the financial data, strip them out.
- Set a timeout (30 seconds) on the AI call. Fall back to Template-Fill on timeout.

### 3.4 Merge AI Content into PDF

Take the AI-generated JSON content and feed it into the same PDF generation engine from Phase 2, but with the customized copy instead of template defaults.

The generation pipeline becomes:

```
Template-Fill mode:
  Template PDF → overlay static text at coordinates → output PDF

AI-Custom mode:
  Template PDF → AI generates custom text → overlay custom text at coordinates → output PDF
```

The coordinates, fonts, and layout are the same — only the text content differs.

### 3.5 Mode Toggle Behavior

In the stepper, the mode toggle (Step 2) now meaningfully changes the flow:

**Template-Fill selected:**
- Step 3: Upload docs → extract numbers only
- Step 6: Generate immediately using template defaults + extracted numbers
- Fast — no AI call needed

**AI-Custom selected:**
- Step 2: Website URL field is more prominent (but still optional)
- Step 3: Upload docs → extract numbers
- Step 6: Generate triggers AI call → uses custom copy → generates PDF
- Slower — show progress: "Customizing your proposal..." with spinner
- If AI call fails → auto-fallback to Template-Fill with notification

---

## ACCEPTANCE CRITERIA FOR PHASE 3

- [ ] AI-Custom mode produces a customized one-page PDF
- [ ] Website scraping works when URL is provided
- [ ] Website scraping failure degrades gracefully (no crash, toast notification)
- [ ] AI-generated headline reflects merchant's business type (when website context available)
- [ ] AI-generated copy does NOT contain fabricated financial numbers
- [ ] Savings amounts in AI output match extracted amounts exactly
- [ ] AI-Custom falls back to Template-Fill on AI call failure
- [ ] AI-Custom falls back to Template-Fill on AI call timeout
- [ ] Template-Fill mode still works exactly as in Phase 2
- [ ] Mode toggle correctly switches between the two pipelines
- [ ] Generated PDF still fits on one page
- [ ] All existing Proposal Generator tabs still work

---

## WHEN DONE
Generate sample PDFs in AI-Custom mode for at least 3 different templates with and without website URLs. Verify the output quality. Report any issues. Then stop and wait for Phase 4 instructions.
