# PCB Auto Dashboard Enhancement — Integration Guide

## Overview

This package contains everything needed to implement the dashboard enhancements based on the DMS feedback review. **Nothing existing is removed** — features are relocated, role-gated, or enhanced.

## File Structure

```
pcb-enhancements/
├── db/
│   ├── migration-dashboard-enhancements.sql   # Run this first
│   └── schema-additions.ts                     # Drizzle schema (merge into your schema.ts)
├── server/
│   └── routes/
│       └── dashboardEnhanced.ts                # All new API endpoints
├── client/
│   ├── hooks/
│   │   └── useDashboardEnhanced.ts             # TanStack Query hooks
│   └── components/
│       ├── dashboard/
│       │   ├── EnhancedDashboard.tsx            # Main dashboard page (replaces current)
│       │   ├── DateRangeFilter.tsx              # Reusable date range picker
│       │   ├── AppointmentsAvailabilityCard.tsx # Hours sold/available widget
│       │   ├── OpenROsCard.tsx                  # Open ROs with date filter
│       │   ├── QuickActionsCard.tsx             # Quick actions + Edit Customer
│       │   └── ShopStatsCard.tsx                # Advisor daily view
│       └── settings/
│           ├── DashboardVisibilitySettings.tsx  # Role-based card toggles
│           ├── BayConfigurationSettings.tsx     # Sellable hours per bay
│           └── StaffAvailabilitySettings.tsx    # Weekly schedule + time off
└── INTEGRATION.md                              # This file
```

---

## Step-by-Step Integration

### Step 1: Run the Database Migration

Open your Replit database shell (or use Drizzle Studio) and run:

```bash
# Option A: Direct SQL execution
psql $DATABASE_URL < db/migration-dashboard-enhancements.sql

# Option B: If you use Drizzle migrations
# 1. Merge schema-additions.ts into your shared/schema.ts
# 2. Run: npx drizzle-kit generate
# 3. Run: npx drizzle-kit push
```

**What this adds:**
- `sellable_hours_per_day` and `sort_order` columns to `pcb_bays`
- `estimated_labor_hours` column to `pcb_appointments`
- `estimated_hours` column to `pcb_service_lines`
- New table: `pcb_staff_availability` (weekly schedules)
- New table: `pcb_staff_time_off` (day-off entries)
- New table: `pcb_dashboard_visibility` (role-based toggles)
- Helper view: `pcb_shop_capacity`

### Step 2: Merge Drizzle Schema

Open your `shared/schema.ts` (or `db/schema.ts`) and:

1. **Add columns to existing tables:**

```typescript
// In your pcb_bays table definition, add:
sellableHoursPerDay: decimal("sellable_hours_per_day", { precision: 4, scale: 1 }).default("8.0"),
sortOrder: integer("sort_order").default(0),

// In your pcb_appointments table definition, add:
estimatedLaborHours: decimal("estimated_labor_hours", { precision: 5, scale: 2 }),

// In your pcb_service_lines table definition, add:
estimatedHours: decimal("estimated_hours", { precision: 5, scale: 2 }),
```

2. **Copy the new table definitions** from `db/schema-additions.ts`:
   - `pcbStaffAvailability`
   - `pcbStaffTimeOff`
   - `pcbDashboardVisibility`
   - All type exports
   - `DASHBOARD_CARDS` and `DEFAULT_VISIBILITY` constants

### Step 3: Add API Routes

In your main Express server file (e.g., `server/index.ts` or `server/routes.ts`):

```typescript
import { dashboardEnhancedRouter } from "./routes/dashboardEnhanced";

// Add after your existing routes
app.use(dashboardEnhancedRouter);
```

**Before the routes will work, you need to:**

1. Open `server/routes/dashboardEnhanced.ts`
2. Fix the imports at the top to match your actual schema import paths:

```typescript
// Replace these placeholder imports with your actual paths:
import { db } from "../db";  // Your Drizzle db instance
import {
  pcbRepairOrders, pcbAppointments, pcbBays, pcbEmployees,
  pcbPayments, pcbCustomers, pcbServiceLines,
  pcbStaffAvailability, pcbStaffTimeOff, pcbDashboardVisibility,
  DEFAULT_VISIBILITY, DASHBOARD_CARDS,
} from "@shared/schema";  // Your schema location
```

3. Make sure `req.tenantId` and `req.user` are set by your auth middleware.

### Step 4: Add Frontend Components

1. **Copy all files** from `client/` into your Replit project's client directory.

2. **Fix hook imports** in each component:
   - Adjust the import path for `useDashboardEnhanced.ts` to match your project structure
   - Make sure `useLocation` from `wouter` is available

3. **Replace your dashboard route:**

In your router file (where you define Wouter routes):

```tsx
import { EnhancedDashboard } from "./components/dashboard/EnhancedDashboard";

// Replace:
// <Route path="/dashboard" component={OldDashboard} />
// With:
<Route path="/dashboard" component={EnhancedDashboard} />
```

4. **Add settings routes:**

```tsx
import { DashboardVisibilitySettings } from "./components/settings/DashboardVisibilitySettings";
import { BayConfigurationSettings } from "./components/settings/BayConfigurationSettings";
import { StaffAvailabilitySettings } from "./components/settings/StaffAvailabilitySettings";

<Route path="/settings/dashboard-visibility" component={DashboardVisibilitySettings} />
<Route path="/settings/bay-configuration" component={BayConfigurationSettings} />
<Route path="/settings/staff-availability" component={StaffAvailabilitySettings} />
```

5. **Add settings navigation links** in your Settings page:

```tsx
// In your Settings page or sidebar, add links:
<Link to="/settings/dashboard-visibility">Dashboard Visibility</Link>
<Link to="/settings/bay-configuration">Bay Configuration</Link>
<Link to="/settings/staff-availability">Staff Availability</Link>
```

### Step 5: Wire Up Auth Context

The `EnhancedDashboard` component has a placeholder for the user name. Find this line:

```typescript
const userName = "there"; // Placeholder — replace with your auth
```

Replace it with your actual auth hook:

```typescript
const { user } = useAuth(); // your auth context
const userName = user?.firstName || "there";
```

### Step 6: Move Existing Elements to Reports

Two dashboard items were relocated per feedback:

**Cash/Card Payment Breakdown (feedback 1e):**
- Remove the donut chart from your current dashboard
- Add it to your Reports page under a "Payment Breakdown" section
- The data is still available via the existing payments API

**Total Customers Count (feedback 1b):**
- Remove the counter from your current dashboard
- Add it as a header stat on the Customers list page:

```tsx
// In your Customers page header
const { data: customerCount } = useQuery({
  queryKey: ["customer-count"],
  queryFn: async () => {
    const res = await fetch("/api/customers/count", { credentials: "include" });
    return res.json();
  },
});

// Display in the page header
<div className="text-sm text-gray-500">
  {customerCount?.total} total customers
</div>
```

---

## What Each Feedback Item Maps To

| Feedback | Change | Files |
|----------|--------|-------|
| 1a: RO date range filter | DateRangeFilter on Open ROs card | DateRangeFilter.tsx, OpenROsCard.tsx |
| 1b: Remove total customers | Moved to Customers page header | EnhancedDashboard.tsx (removed) |
| 1c: Appointments/Availability | New widget with bay capacity | AppointmentsAvailabilityCard.tsx |
| 1d: Revenue visibility by role | Toggle grid in Settings | DashboardVisibilitySettings.tsx |
| 1e: Remove cash/card tally | Moved to Reports | EnhancedDashboard.tsx (removed) |
| 1f: Edit Customer quick action | Added to Quick Actions | QuickActionsCard.tsx |
| 1g: Advisor daily view | Shop Stats card + Who's Off | ShopStatsCard.tsx |

---

## Testing Checklist

After integration, verify:

- [ ] Dashboard loads without errors
- [ ] Date range filter changes affect all cards
- [ ] "All Open" RO toggle shows all non-paid/cancelled ROs
- [ ] Owner sees all cards
- [ ] Service advisor sees only enabled cards
- [ ] Technician sees only their assigned ROs
- [ ] Bay configuration saves sellable hours
- [ ] Staff availability toggle works for each day
- [ ] Time off entries appear in "Who's Off" widget
- [ ] Quick Actions "Edit Customer" opens search-then-edit flow
- [ ] Settings pages are only accessible to owner/admin roles
- [ ] Existing dashboard features still work (ARO, approval rate, etc.)
- [ ] Mobile responsive: cards stack properly on phone
