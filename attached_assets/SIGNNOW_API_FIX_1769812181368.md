# SignNow API Integration Fix

## ðŸ”´ QUICK FIX SUMMARY

Your brochuretracker.com is failing because:

1. **Your PDFs have NO native fillable fields** - SignNow can't prefill or create role-based invites for empty documents
2. **You're using wrong invite format** - Documents with fields require role-based invites with `role`, `role_id`, `order`

### Immediate Fix Options:

**Option A (Quick):** Create templates in SignNow UI first, then copy/fill/invite via API
**Option B (Automated):** Add fields programmatically after upload, then invite

See detailed instructions below.

---

## Problem Diagnosis

Based on API logs showing:
- `POST /document` â†’ 200 OK âœ“
- `PUT /document/{id}` â†’ 400 Bad Request âœ—
- `POST /document/{id}/invite` â†’ 400 Bad Request âœ—

## âš ï¸ CRITICAL DISCOVERY

**Your PDF forms do NOT have native fillable fields!**

I checked all your PDFs:
- Charity_Form.pdf - NO fillable fields
- Download_Sheet.pdf - NO fillable fields  
- Equipment_Purchase.pdf - NO fillable fields
- No_Charge_Terminal.pdf - NO fillable fields
- PCI_Form.pdf - NO fillable fields
- Quick_App.pdf - NO fillable fields

This means you MUST **add fields programmatically** after uploading, or use SignNow's editor to add fields to templates.

---

## Root Causes

### Issue 1: PUT /document fails
**Cause**: Trying to prefill fields that don't exist on the document yet.

### Issue 2: POST /invite fails  
**Cause**: Either no fields exist (can't do role-based), or wrong invite format.

---

## Two Possible Solutions

### Option A: Add Fields Programmatically (Recommended)
Upload â†’ Add Fields â†’ Invite

### Option B: Use SignNow Templates (Easier)
Create templates in SignNow UI with fields â†’ Copy template â†’ Fill â†’ Invite

---

## Option B: Use SignNow Templates (Recommended for Production)

This is the **recommended approach** - create templates once in SignNow, then copy and fill them.

### Step 1: Create Templates in SignNow (One-time setup)

1. Log into SignNow at https://app.signnow.com
2. Upload each PDF (Charity_Form.pdf, Quick_App.pdf, etc.)
3. Click on the document to open the editor
4. Add fillable fields:
   - Drag Signature fields where signatures go
   - Drag Text fields for business name, owner name, etc.
   - Assign fields to "Signer 1" role
5. Click "Actions" â†’ "Save as Template"
6. Note the Template ID for each form

### Step 2: Copy Template and Fill Programmatically

```javascript
// POST /template/{template_id}/copy
const copyTemplate = async (templateId, accessToken, documentName) => {
  const response = await fetch(`https://api.signnow.com/template/${templateId}/copy`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      document_name: documentName  // e.g., "Charity Form - Bob's Marine"
    })
  });
  
  const { id } = await response.json();
  return id;  // This is a new document based on the template
};

// Example usage
const documentId = await copyTemplate('YOUR_CHARITY_TEMPLATE_ID', token, "Charity Form - Bob's Marine");
```

### Step 3: Prefill Fields (Now they exist!)

```javascript
// PUT /v2/documents/{document_id}/prefill-texts
const prefillDocument = async (documentId, accessToken, merchantData) => {
  const response = await fetch(
    `https://api.signnow.com/v2/documents/${documentId}/prefill-texts`,
    {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        fields: [
          { field_name: 'Business Name', prefilled_text: merchantData.businessName },
          { field_name: 'Business Owner Name', prefilled_text: merchantData.ownerName },
          { field_name: 'Charity Name', prefilled_text: merchantData.charityName || '' }
        ]
      })
    }
  );
  
  return response.json();
};
```

### Step 4: Send Role-Based Invite

```javascript
// POST /document/{document_id}/invite
const sendInvite = async (documentId, accessToken, signerEmail, senderEmail) => {
  const response = await fetch(`https://api.signnow.com/document/${documentId}/invite`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      to: [{
        email: signerEmail,
        role: 'Signer 1',     // Must match the role in template
        role_id: '',          // Can be empty
        order: 1,
        reassign: '0',
        decline_by_signature: '0',
        reminder: 3,
        expiration_days: 30,
        subject: 'PCBancard - Please Sign Your Application',
        message: 'Please review and sign the attached document.'
      }],
      from: senderEmail
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(`Invite failed: ${error.message || JSON.stringify(error)}`);
  }
  
  return response.json();
};
```

### Complete Template Workflow

```javascript
const processWithTemplate = async (templateId, merchantData, signerEmail, senderEmail) => {
  // 1. Get access token (OAuth)
  const token = await getAccessToken();
  
  // 2. Copy template to new document
  const documentId = await copyTemplate(templateId, token, 
    `${merchantData.formName} - ${merchantData.businessName}`);
  
  // 3. Prefill fields
  await prefillDocument(documentId, token, merchantData);
  
  // 4. Send for signature
  const result = await sendInvite(documentId, token, signerEmail, senderEmail);
  
  return { documentId, inviteId: result.id };
};

// Usage
await processWithTemplate(
  'abc123def456',  // Your Charity Form template ID
  {
    formName: 'Charity Form',
    businessName: "Bob's Marine",
    ownerName: 'Bob Johnson',
    charityName: 'Local Food Bank'
  },
  'bob@bobsmarine.com',
  'agent@pcbancard.com'
);
```

### Template IDs to Create

Create these templates in SignNow:

| Form | Suggested Template Name | Fields to Add |
|------|------------------------|---------------|
| Charity_Form.pdf | PCB-Charity-Template | Business Name, Owner Name, Signature, Charity fields |
| Quick_App.pdf | PCB-QuickApp-Template | All business/owner fields, Signature |
| PCI_Form.pdf | PCB-PCI-Template | Business Name, Owner Name, Date, Signature |
| No_Charge_Terminal.pdf | PCB-FreeEquip-Template | DBA Name, P1/P3 checkboxes, Signatures |
| Equipment_Purchase.pdf | PCB-EquipPurchase-Template | DBA, Address, Terminal type, Signatures |
| Download_Sheet.pdf | PCB-Download-Template | DBA, Address, Terminal checkboxes |

### Step 0: Upload Document First
```javascript
const uploadDocument = async (pdfBuffer, accessToken) => {
  const formData = new FormData();
  formData.append('file', new Blob([pdfBuffer]), 'document.pdf');
  
  const response = await fetch('https://api.signnow.com/document', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`
    },
    body: formData
  });
  
  const { id } = await response.json();
  return id;
};
```

### Step 1: ADD Fields to Document (This is the missing step!)

After uploading, you need to ADD signature and text fields:

```javascript
// PUT /document/{document_id}
const addFieldsToDocument = async (documentId, accessToken, fields) => {
  const response = await fetch(`https://api.signnow.com/document/${documentId}`, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      fields: fields
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(`Add fields failed: ${JSON.stringify(error)}`);
  }
  
  return response.json();
};

// Example: Add signature and text fields to Charity Form
const charityFormFields = [
  // Business Name - text field
  {
    type: 'text',
    x: 200,           // X position (points from left)
    y: 168,           // Y position (points from bottom)
    width: 300,
    height: 20,
    page_number: 0,   // First page (0-indexed)
    role: 'Signer 1',
    required: true,
    label: 'Business Name',
    prefilled_text: "Bob's Marine"  // Optional: prefill value
  },
  // Business Owner Name
  {
    type: 'text',
    x: 200,
    y: 140,
    width: 300,
    height: 20,
    page_number: 0,
    role: 'Signer 1',
    required: true,
    label: 'Business Owner Name'
  },
  // Owner Signature
  {
    type: 'signature',
    x: 200,
    y: 112,
    width: 200,
    height: 30,
    page_number: 0,
    role: 'Signer 1',
    required: true,
    label: 'Business Owner Signature'
  },
  // Charity Name
  {
    type: 'text',
    x: 200,
    y: 300,
    width: 300,
    height: 20,
    page_number: 0,
    role: 'Signer 1',
    label: 'Charity Name'
  },
  // Yes/No checkbox for signage
  {
    type: 'checkbox',
    x: 80,
    y: 480,
    width: 20,
    height: 20,
    page_number: 0,
    role: 'Signer 1',
    label: 'Want Signage'
  }
];

await addFieldsToDocument(documentId, token, charityFormFields);
```

### Field Types Available

| Type | Description | Extra Properties |
|------|-------------|------------------|
| `signature` | Signature field | |
| `text` | Text input | `prefilled_text`, `validator_id` |
| `initials` | Initials field | |
| `date` | Date field | `lock_to_sign_date` |
| `checkbox` | Checkbox | `prefilled_text: "checked"` or `""` |
| `radiobutton` | Radio group | `radio_group_name` |
| `dropdown` | Dropdown select | `enumeration_options` |

### Field Position Calculation

PDF coordinates have **Y=0 at the bottom**. For an 8.5" x 11" page (612 x 792 points):
- Top of page: Y â‰ˆ 750
- Middle: Y â‰ˆ 400
- Bottom: Y â‰ˆ 50

### Step 2: Get Document to Verify Fields Added

```javascript
const getDocument = async (documentId, accessToken) => {
  const response = await fetch(`https://api.signnow.com/document/${documentId}`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${accessToken}`
    }
  });
  
  const doc = await response.json();
  console.log('Fields added:', doc.fields?.length || 0);
  console.log('Roles:', doc.roles);
  return doc;
};
```

---

## Solution: Use Role-Based Invites

Documents with fillable fields (like PCBancard forms) require **role-based invites** with specific parameters.

### Step 1: Get Document Roles

After uploading a document, retrieve the document to get the role information:

```javascript
// GET /document/{document_id}
const getDocument = async (documentId, accessToken) => {
  const response = await fetch(`https://api.signnow.com/document/${documentId}`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    }
  });
  
  const doc = await response.json();
  
  // Extract roles from the document
  // Each role has: unique_id, name, signing_order
  console.log('Document roles:', doc.roles);
  console.log('Document fields:', doc.fields);
  
  return doc;
};
```

### Step 2: Prefill Text Fields (Correct Format)

Use the **v2 prefill endpoint** for better results:

```javascript
// PUT /v2/documents/{document_id}/prefill-texts
const prefillFields = async (documentId, accessToken, fieldData) => {
  const response = await fetch(
    `https://api.signnow.com/v2/documents/${documentId}/prefill-texts`,
    {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        fields: fieldData.map(field => ({
          field_name: field.name,      // The field's label/name
          prefilled_text: field.value  // The value to prefill
        }))
      })
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(`Prefill failed: ${JSON.stringify(error)}`);
  }
  
  return response.json();
};

// Example usage:
await prefillFields(documentId, token, [
  { name: 'Business Name', value: "Bob's Marine" },
  { name: 'Business Owner Name', value: 'Bob Johnson' },
  { name: 'Phone Number', value: '(317) 555-1234' }
]);
```

### Step 3: Send Role-Based Invite (CRITICAL FIX)

This is the main fix. The invite must include `role`, `role_id`, and `order`:

```javascript
// POST /document/{document_id}/invite
const sendRoleBasedInvite = async (documentId, accessToken, inviteData) => {
  const requestBody = {
    to: [
      {
        email: inviteData.signerEmail,
        role: inviteData.roleName || 'Signer 1',  // REQUIRED: Role name
        role_id: inviteData.roleId || '',          // Can be empty string
        order: 1,                                   // REQUIRED: Signing order
        reassign: '0',                              // Optional: Allow reassignment
        decline_by_signature: '0',                  // Optional: Allow decline
        reminder: inviteData.reminderDays || 0,    // Optional: Reminder in days
        expiration_days: inviteData.expirationDays || 30,
        subject: inviteData.subject || 'Please sign this document',
        message: inviteData.message || 'Please review and sign the attached document.'
      }
    ],
    from: inviteData.senderEmail  // MUST match your SignNow login email
  };

  const response = await fetch(
    `https://api.signnow.com/document/${documentId}/invite`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    }
  );

  if (!response.ok) {
    const error = await response.json();
    console.error('Invite error:', error);
    throw new Error(`Invite failed: ${JSON.stringify(error)}`);
  }

  return response.json();
};
```

---

## Complete Working Example

```javascript
// Full workflow: Upload â†’ Prefill â†’ Invite

const signNowWorkflow = async (pdfBuffer, merchantData, signerEmail, senderEmail) => {
  const API_BASE = 'https://api.signnow.com';  // Use api-eval.signnow.com for sandbox
  
  // Step 1: Get access token
  const tokenResponse = await fetch(`${API_BASE}/oauth2/token`, {
    method: 'POST',
    headers: {
      'Authorization': `Basic ${Buffer.from(`${CLIENT_ID}:${CLIENT_SECRET}`).toString('base64')}`,
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
      grant_type: 'password',
      username: SIGNNOW_USERNAME,
      password: SIGNNOW_PASSWORD,
      scope: '*'
    })
  });
  const { access_token } = await tokenResponse.json();

  // Step 2: Upload document
  const formData = new FormData();
  formData.append('file', new Blob([pdfBuffer]), 'document.pdf');
  
  const uploadResponse = await fetch(`${API_BASE}/document`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${access_token}`
    },
    body: formData
  });
  const { id: documentId } = await uploadResponse.json();
  console.log('Document uploaded:', documentId);

  // Step 3: Get document to retrieve roles
  const docResponse = await fetch(`${API_BASE}/document/${documentId}`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${access_token}`
    }
  });
  const document = await docResponse.json();
  
  // Find the signer role
  const signerRole = document.roles?.[0] || { name: 'Signer 1', unique_id: '' };
  console.log('Using role:', signerRole);

  // Step 4: Prefill text fields (if document has text fields)
  if (document.fields?.length > 0) {
    const fieldsToFill = [];
    
    document.fields.forEach(field => {
      if (field.type === 'text' && merchantData[field.name]) {
        fieldsToFill.push({
          field_name: field.name,
          prefilled_text: merchantData[field.name]
        });
      }
    });

    if (fieldsToFill.length > 0) {
      await fetch(`${API_BASE}/v2/documents/${documentId}/prefill-texts`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${access_token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fields: fieldsToFill })
      });
      console.log('Fields prefilled:', fieldsToFill.length);
    }
  }

  // Step 5: Send role-based invite
  const inviteBody = {
    to: [
      {
        email: signerEmail,
        role: signerRole.name || 'Signer 1',
        role_id: signerRole.unique_id || '',
        order: 1,
        reassign: '0',
        decline_by_signature: '0',
        reminder: 3,
        expiration_days: 30,
        subject: 'PCBancard - Please Sign Your Application',
        message: `Hi ${merchantData.ownerName},\n\nPlease review and sign the attached merchant application.\n\nThank you!`
      }
    ],
    from: senderEmail
  };

  const inviteResponse = await fetch(`${API_BASE}/document/${documentId}/invite`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${access_token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(inviteBody)
  });

  if (!inviteResponse.ok) {
    const error = await inviteResponse.json();
    throw new Error(`Invite failed: ${JSON.stringify(error)}`);
  }

  const inviteResult = await inviteResponse.json();
  console.log('Invite sent successfully:', inviteResult);

  return {
    documentId,
    inviteId: inviteResult.id
  };
};
```

---

## Common Error Messages & Solutions

### "Cannot send invite for document with fields"
**Cause**: Sending freeform invite to document with fillable fields  
**Fix**: Add `role`, `role_id`, and `order` parameters to the `to` array

### "Invalid role" or "Role not found"
**Cause**: Role name doesn't match document's roles  
**Fix**: First GET the document and use the actual role name from `document.roles`

### "400 Bad Request" on PUT /document
**Cause**: Incorrect field update format  
**Fix**: Use v2 endpoint `/v2/documents/{id}/prefill-texts` with correct structure

### "from email must match account email"
**Cause**: The `from` email doesn't match your SignNow login  
**Fix**: Use your SignNow account email as the sender

---

## Field Mapping for PCBancard Forms

When prefilling fields, use the exact field names from the PDF:

### Charity Form Fields
```javascript
{
  'Business Name': merchantData.businessName,
  'Business Owner Name': merchantData.ownerName,
  'Charity Name': merchantData.charityName,
  'Charity Address': merchantData.charityAddress,
  'City/State/Zip': merchantData.charityCityStateZip,
  'Phone Number': merchantData.charityPhone,
  'Email Address': merchantData.charityEmail,
  'Website': merchantData.charityWebsite
}
```

### PCI Form Fields
```javascript
{
  'Business Name': merchantData.businessName,
  'Owner Name (Printed)': merchantData.ownerName,
  'Date': new Date().toLocaleDateString()
}
```

### Quick App Fields
```javascript
{
  'Business Name': merchantData.dbaName,
  'Corporate Legal Business Name': merchantData.corporateLegalName,
  'Business Location Address': merchantData.businessAddress,
  'Business Phone': merchantData.businessPhone,
  'Business Email': merchantData.businessEmail,
  'Business Website': merchantData.businessWebsite,
  'Federal Tax ID': merchantData.federalTaxId,
  'Owner/Officer/Partner Name': merchantData.ownerName,
  'Personal Phone': merchantData.ownerPhone,
  'Personal Email': merchantData.ownerEmail,
  'Date of Birth': merchantData.ownerDOB,
  'Soc Sec #': merchantData.ownerSSN,
  'Owner/Officer/Partner Home Address': merchantData.ownerHomeAddress
}
```

---

## Alternative: Embedded Signing (No Email)

If you want signers to sign immediately without email:

```javascript
// POST /v2/documents/{document_id}/embedded-invites
const createEmbeddedInvite = async (documentId, accessToken, roleId, signerEmail) => {
  const response = await fetch(
    `https://api.signnow.com/v2/documents/${documentId}/embedded-invites`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        invites: [
          {
            email: signerEmail,
            role_id: roleId,
            order: 1,
            auth_method: 'none'  // or 'password', 'email'
          }
        ]
      })
    }
  );
  
  return response.json();
};

// Then generate signing link
// POST /v2/documents/{document_id}/embedded-invites/{invite_id}/link
const getSigningLink = async (documentId, inviteId, accessToken) => {
  const response = await fetch(
    `https://api.signnow.com/v2/documents/${documentId}/embedded-invites/${inviteId}/link`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        link_expiration: 45  // minutes
      })
    }
  );
  
  const { link } = await response.json();
  // Redirect user to this link to sign
  return link;
};
```

---

## Debugging Tips

1. **Log the full error response**:
```javascript
const response = await fetch(url, options);
if (!response.ok) {
  const errorBody = await response.text();
  console.error('Status:', response.status);
  console.error('Body:', errorBody);
}
```

2. **Check document has roles**:
```javascript
const doc = await getDocument(documentId, token);
console.log('Roles:', JSON.stringify(doc.roles, null, 2));
console.log('Fields:', JSON.stringify(doc.fields, null, 2));
```

3. **Verify field names match**:
Field names are case-sensitive and must exactly match what's in the PDF.

---

## API Endpoints Reference

| Action | Method | Endpoint |
|--------|--------|----------|
| Upload document | POST | `/document` |
| Get document | GET | `/document/{id}` |
| Prefill fields (v2) | PUT | `/v2/documents/{id}/prefill-texts` |
| Send role invite | POST | `/document/{id}/invite` |
| Create embedded invite | POST | `/v2/documents/{id}/embedded-invites` |
| Get signing link | POST | `/v2/documents/{id}/embedded-invites/{invite_id}/link` |
| Get invite status | GET | `/document/{id}/invite` |
| Cancel invite | DELETE | `/document/{id}/fieldinvitecancel` |

---

## Contact SignNow Support

If issues persist:
- Email: api@signnow.com
- API Status: https://signnow.statuspage.io/
- Documentation: https://docs.signnow.com
