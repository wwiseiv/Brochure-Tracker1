# PCBancard RBAC + Feature Access Control System

A complete role-based access control system with agent stages for progressive feature unlocking.

## Architecture Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PERMISSION RESOLUTION ORDER                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Admin role?          → ALLOW ALL                                         │
│  2. Critical feature?    → ALLOW (login, profile, help)                      │
│  3. Explicit override?   → Use override value                                │
│  4. Agent? Use stage     → trainee/active/senior defaults                    │
│  5. Role default         → manager/agent defaults                            │
│  6. Default              → DENY                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Quick Start: Training-Only Agent

For brand new agents who should ONLY have training features:

1. Create user account
2. They automatically get: `role: agent`, `agentStage: trainee`
3. Trainee stage grants access to ONLY:
   - ✅ Sales Spark
   - ✅ AI Coaching  
   - ✅ Practice Role Play
   - ✅ Teach Me The Presentation
   - ✅ EquipIQ
   - ✅ Daily Edge
   - ✅ AI Help Assistant
   - ❌ Everything else (Pipeline, CRM, Drops, Proposals, etc.)

## Roles & Stages

### Roles (3 levels)
| Role | Description | Can Manage |
|------|-------------|------------|
| `admin` | Full access to everything | Roles, stages, all features |
| `manager` | Team oversight + all agent features | Agent stages, agent overrides |
| `agent` | Access controlled by stage | Nothing |

### Agent Stages (3 levels)
| Stage | Description | Features Added |
|-------|-------------|----------------|
| `trainee` | New agents, training only | Sales Spark, Role Play, EquipIQ, Presentation, Daily Edge |
| `active` | Field-ready agents | + Pipeline, CRM, Drops, Email Drafter, E-Sign, Referrals |
| `senior` | Experienced agents | + Statement Analyzer, Proposal Generator, Pipeline Analytics |

## File Structure

```
pcbancard-rbac/
├── shared/
│   └── permissions.ts          # Feature registry + permission engine (SINGLE SOURCE OF TRUTH)
├── db/
│   └── migrations/
│       └── 001_rbac_permissions.sql   # Database schema
├── server/
│   ├── routes/
│   │   └── permissionRoutes.ts        # API endpoints for permission management
│   └── middleware/
│       └── permissionMiddleware.ts    # Route + API protection middleware
└── client/
    ├── contexts/
    │   └── PermissionContext.tsx      # React context + hooks
    ├── components/
    │   └── Navigation.tsx             # Permission-aware navigation
    └── pages/
        └── UserPermissionsAdmin.tsx   # Admin/Manager UI
```

## Feature Registry

All 30+ features defined in `shared/permissions.ts`:

### Training Features (Trainee+)
- `sales_spark` - Real-time AI sales intelligence
- `ai_coaching` - AI coaching advice
- `role_play` - Practice role play conversations
- `presentation_training` - 8-module presentation training
- `equipiq` - Equipment recommendation advisor
- `daily_edge` - Daily mindset training
- `ai_help_assistant` - Floating help chatbot

### CRM Features (Active+)
- `deal_pipeline` - 14-stage Kanban pipeline
- `merchant_crm` - Merchant profiles
- `today_dashboard` - Daily action center
- `prospect_finder` - AI prospect discovery
- `business_card_scanner` - OCR card scanning

### Drop Features (Active+)
- `drop_logging` - Brochure drop logging
- `brochure_inventory` - Inventory tracking
- `route_planner` - Route optimization

### AI Tools (Senior for some)
- `statement_analyzer` - Statement analysis (Senior only)
- `proposal_generator` - Proposal creation (Senior only)
- `ai_email_drafter` - Email generation (Active+)
- `marketing_generator` - Flyer creation (Active+)

### Team Features (Manager+)
- `team_management` - Manage team members
- `team_pipeline` - View team pipeline
- `activity_feed` - Team activity stream
- `user_permissions` - Manage user access

### Admin Only
- `admin_dashboard` - Org settings
- `feature_toggles` - Org-wide feature toggles

## Installation

### 1. Run Database Migration

```bash
psql -d your_database -f db/migrations/001_rbac_permissions.sql
```

### 2. Server Setup

```typescript
// server/index.ts
import express from 'express';
import permissionRoutes from './routes/permissionRoutes';
import { 
  loadPermissionsMiddleware, 
  autoRouteGate 
} from './middleware/permissionMiddleware';

const app = express();

// After your auth middleware...
app.use(loadPermissionsMiddleware());

// Mount permission management API
app.use('/api', permissionRoutes);

// Auto-gate all routes based on feature registry
app.use(autoRouteGate());
```

### 3. Client Setup

```tsx
// App.tsx
import { PermissionProvider } from './contexts/PermissionContext';

function App() {
  return (
    <PermissionProvider>
      <Router>
        <Routes>
          {/* Your routes */}
        </Routes>
      </Router>
    </PermissionProvider>
  );
}
```

## Usage Examples

### Server-Side Route Protection

```typescript
import { requireFeature, requireRole, requireStage } from './middleware/permissionMiddleware';

// Require specific feature
router.get('/pipeline', requireFeature('deal_pipeline'), pipelineHandler);

// Require minimum role
router.get('/team', requireRole('manager'), teamHandler);

// Require minimum stage (agents only, managers+ bypass)
router.get('/proposals', requireStage('senior'), proposalHandler);
```

### Client-Side Conditional Rendering

```tsx
import { useFeatureAccess, RequireFeature, RequireRole } from './contexts/PermissionContext';

// Hook
function MyComponent() {
  const hasPipeline = useFeatureAccess('deal_pipeline');
  if (!hasPipeline) return <LockedMessage />;
  return <PipelineView />;
}

// Component
function Dashboard() {
  return (
    <div>
      <RequireFeature feature="deal_pipeline" showLocked>
        <PipelineWidget />
      </RequireFeature>
      
      <RequireRole role="manager">
        <TeamOverview />
      </RequireRole>
    </div>
  );
}
```

### Permission-Aware Navigation

The navigation component automatically hides items the user can't access:

```tsx
import { MainNavigation, MobileBottomNav } from './components/Navigation';

function Layout({ children }) {
  return (
    <div className="flex">
      <MainNavigation />  {/* Only shows accessible items */}
      <main>{children}</main>
      <MobileBottomNav /> {/* Respects permissions */}
    </div>
  );
}
```

## API Endpoints

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/api/permissions/me` | GET | Any | Get current user's permissions |
| `/api/permissions/features` | GET | Any | Get feature registry |
| `/api/permissions/users` | GET | Manager+ | List users with permissions |
| `/api/permissions/users/:id` | GET | Manager+ | Get user's permissions |
| `/api/permissions/users/:id/role` | PATCH | Admin | Change user role |
| `/api/permissions/users/:id/stage` | PATCH | Manager+ | Change agent stage |
| `/api/permissions/users/:id/override` | POST | Manager+ | Add feature override |
| `/api/permissions/users/:id/preset` | POST | Manager+ | Apply permission preset |

## Verification Checklist

### As Admin:
- [ ] Can see all navigation items
- [ ] Can access User Permissions page
- [ ] Can change user roles (admin/manager/agent)
- [ ] Can change agent stages
- [ ] Can add/remove feature overrides

### As Manager:
- [ ] Can see team management features
- [ ] Can access User Permissions page
- [ ] Can change agent stages
- [ ] Cannot change roles to admin/manager
- [ ] Can add overrides for agents

### As Trainee Agent:
- [ ] Can see ONLY: Dashboard, Sales Spark, Role Play, Presentation, EquipIQ, Daily Edge
- [ ] CANNOT see: Pipeline, Merchants, Drops, Statement Analyzer, Proposals
- [ ] Navigating to /pipeline shows "No Access" page
- [ ] API call to /api/deals returns 403

### As Active Agent:
- [ ] Can see all trainee features PLUS: Pipeline, Merchants, Drops, Email Drafter
- [ ] CANNOT see: Statement Analyzer, Proposal Generator
- [ ] API call to /api/statement-analyzer returns 403

### As Senior Agent:
- [ ] Can see all features except team management
- [ ] Can use Statement Analyzer and Proposal Generator

## Security Guarantees

1. **URL Protection**: Direct navigation to restricted routes returns 403 or redirects
2. **API Protection**: All API endpoints check permissions server-side
3. **Central Enforcement**: All permission logic in one place (`permissions.ts` + middleware)
4. **Audit Trail**: All permission changes logged to `permission_audit_log`
5. **Cache Invalidation**: Permissions refresh within 30 seconds of changes

## Presets

Quick presets for common configurations:

| Preset | Role | Stage | Description |
|--------|------|-------|-------------|
| `training_only` | agent | trainee | New agent, training features only |
| `active_seller` | agent | active | Field-ready with CRM/drops |
| `full_agent` | agent | senior | All agent features |
| `manager` | manager | - | Team oversight |

Apply via Admin UI or API:
```bash
POST /api/permissions/users/123/preset
{ "presetId": "training_only" }
```

## Adding New Features

1. Add to `FEATURES` array in `shared/permissions.ts`:
```typescript
{
  id: 'new_feature',
  name: 'New Feature',
  description: 'What it does',
  category: 'ai_tools',
  routes: ['/new-feature'],
  apiEndpoints: ['/api/new-feature/*'],
  roleDefaults: { admin: true, manager: true, agent: true },
  stageDefaults: { trainee: false, active: true, senior: true }
}
```

2. That's it! The feature is now:
   - Gated in navigation
   - Protected at route level
   - Protected at API level
   - Available in admin UI

## Troubleshooting

### User can't access feature they should have
1. Check their role: `/api/permissions/users/:id`
2. Check their stage (if agent)
3. Check for explicit `false` override
4. Check org-level feature toggle

### Permission changes not taking effect
- Cache TTL is 30 seconds
- Force refresh: `invalidatePermissionCache(orgId, userId)`

### New feature not appearing in nav
- Ensure feature is in `permissions.ts`
- Ensure nav item has `featureId` set
- Check browser console for errors
